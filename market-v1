import os
import pandas as pd
import numpy as np
import requests
import json
import time
import datetime
from tqdm import tqdm
import matplotlib.pyplot as plt
from concurrent.futures import ThreadPoolExecutor, as_completed
import argparse
from typing import Dict, List, Tuple, Any, Optional, Union
import warnings
warnings.filterwarnings("ignore")

# è®¾ç½®matplotlibä¸­æ–‡å­—ä½“æ”¯æŒ
plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei', 'Arial Unicode MS']
plt.rcParams['axes.unicode_minus'] = False


class FundInvestment:
    """åŸºé‡‘å®šæŠ•æ”¶ç›Šåˆ†æå·¥å…·"""

    def __init__(self, fund_id: str, investment_amount: float = 200, profit_threshold: float = 0.1):
        """
        åˆå§‹åŒ–åŸºé‡‘å®šæŠ•åˆ†æå·¥å…·
        
        å‚æ•°:
            fund_id: åŸºé‡‘ä»£ç 
            investment_amount: æ¯æ¬¡å®šæŠ•é‡‘é¢(å…ƒ)
            profit_threshold: æ”¶ç›Šç‡é˜ˆå€¼ï¼Œè¾¾åˆ°è¯¥é˜ˆå€¼æ—¶å–å‡º(å°æ•°å½¢å¼ï¼Œå¦‚0.1è¡¨ç¤º10%)
        """
        self.fund_id = fund_id
        self.investment_amount = investment_amount
        self.profit_threshold = profit_threshold
        self.data_dir = "fund_data"
        self.results_dir = "investment_results"
        self.ensure_dirs()
        
        # åˆå§‹åŒ–æŠ•èµ„çŠ¶æ€
        self.reset_investment_status()
        
        # åˆå§‹åŒ–æ•°æ®
        self.fund_data = None
        self.fund_info = None
        
        # ç¼“å­˜
        self._fund_data_cache = {}
        
    def ensure_dirs(self):
        """ç¡®ä¿æ•°æ®å’Œç»“æœç›®å½•å­˜åœ¨"""
        for directory in [self.data_dir, self.results_dir]:
            if not os.path.exists(directory):
                os.makedirs(directory)
    
    def get_data_file_path(self):
        """è·å–åŸºé‡‘æ•°æ®æ–‡ä»¶è·¯å¾„"""
        return os.path.join(self.data_dir, f"fund_{self.fund_id}.csv")
    
    def get_fund_info_path(self):
        """è·å–åŸºé‡‘ä¿¡æ¯æ–‡ä»¶è·¯å¾„"""
        return os.path.join(self.data_dir, f"fund_{self.fund_id}_info.json")
    
    def get_results_file_path(self, extension: str = "txt", threshold: Optional[float] = None):
        """
        è·å–ç»“æœæ–‡ä»¶è·¯å¾„
        
        å‚æ•°:
            extension: æ–‡ä»¶æ‰©å±•å
            threshold: æ”¶ç›Šé˜ˆå€¼ï¼Œå¦‚æœæä¾›åˆ™ä½¿ç”¨ç‰¹å®šé˜ˆå€¼çš„æ–‡ä»¶å
        """
        if threshold is not None:
            return os.path.join(self.results_dir, f"fund_{self.fund_id}_threshold_{int(threshold*100)}pct.{extension}")
        return os.path.join(self.results_dir, f"fund_{self.fund_id}_results.{extension}")
    
    def reset_investment_status(self):
        """é‡ç½®æŠ•èµ„çŠ¶æ€"""
        self.total_investment = 0  # æ€»æŠ•èµ„é‡‘é¢
        self.current_value = 0     # å½“å‰ä»·å€¼
        self.units_held = 0        # æŒæœ‰ä»½é¢
        self.investment_dates = [] # æŠ•èµ„æ—¥æœŸ
        self.reset_logs = []       # é‡ç½®è®°å½•
        
    def fetch_fund_data(self):
        """ä»ç½‘ç»œè·å–åŸºé‡‘æ•°æ®"""
        print(f"æ­£åœ¨è·å–åŸºé‡‘ {self.fund_id} çš„å†å²æ•°æ®...")
        
        try:
            # è·å–åŸºé‡‘ä¿¡æ¯
            info_url = f"http://fund.eastmoney.com/pingzhongdata/{self.fund_id}.js"
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                'Referer': 'http://fund.eastmoney.com/'
            }
            
            response = requests.get(info_url, headers=headers, timeout=10)
            response.raise_for_status()  # æ£€æŸ¥HTTPé”™è¯¯
            
            # æå–æ•°æ®éƒ¨åˆ†
            content = response.text
            
            # æå–åŸºé‡‘åç§°
            fund_name_match = content.find('fS_name = "') + 11
            fund_name_end = content.find('";', fund_name_match)
            fund_name = content[fund_name_match:fund_name_end]
            
            # æå–æˆç«‹æ—¥æœŸ
            establish_date_match = content.find('ESTABDATE = "') + 12
            establish_date_end = content.find('";', establish_date_match)
            establish_date = content[establish_date_match:establish_date_end]
            
            # æå–å†å²å‡€å€¼æ•°æ®
            data_match = content.find('Data_netWorthTrend = ') + 21
            data_end = content.find(';', data_match)
            data_json = content[data_match:data_end]
            
            # è§£æJSONæ•°æ®
            historical_data = json.loads(data_json)
            
            # ä¿å­˜åŸºé‡‘åŸºæœ¬ä¿¡æ¯
            fund_info = {
                "fund_id": self.fund_id,
                "fund_name": fund_name,
                "establish_date": establish_date
            }
            
            with open(self.get_fund_info_path(), 'w', encoding='utf-8') as f:
                json.dump(fund_info, f, ensure_ascii=False, indent=4)
            
            # è½¬æ¢ä¸ºDataFrameæ ¼å¼
            dates = []
            values = []
            
            for item in historical_data:
                # æ—¶é—´æˆ³è½¬æ¢ä¸ºæ—¥æœŸ
                date = pd.to_datetime(item['x'], unit='ms')
                value = item['y']  # å‡€å€¼
                
                dates.append(date)
                values.append(value)
            
            # åˆ›å»ºå¹¶ä¿å­˜DataFrame
            df = pd.DataFrame({
                'date': dates,
                'value': values
            })
            
            df.sort_values('date', inplace=True)
            df.to_csv(self.get_data_file_path(), index=False)
            
            print(f"æˆåŠŸè·å– {fund_name} ({self.fund_id}) çš„å†å²æ•°æ®ï¼Œä» {df['date'].min().date()} åˆ° {df['date'].max().date()}")
            print(f"æ•°æ®å·²ä¿å­˜è‡³ {self.get_data_file_path()}")
            
            self.fund_info = fund_info
            return df
        
        except Exception as e:
            print(f"è·å–åŸºé‡‘æ•°æ®æ—¶å‡ºé”™: {e}")
            
            # åˆ›å»ºç¤ºä¾‹æ•°æ®
            print("ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä»£æ›¿...")
            return self.create_mock_data()
    
    def create_mock_data(self):
        """åˆ›å»ºæ¨¡æ‹ŸåŸºé‡‘æ•°æ®"""
        print("åˆ›å»ºæ¨¡æ‹ŸåŸºé‡‘æ•°æ®...")
        
        # è®¾ç½®æ—¶é—´èŒƒå›´ (3å¹´)
        end_date = datetime.datetime.now()
        start_date = end_date - datetime.timedelta(days=3*365)
        
        # åˆ›å»ºäº¤æ˜“æ—¥
        dates = pd.date_range(start=start_date, end=end_date, freq='B')
        
        # åˆå§‹ä»·æ ¼
        price = 1.0
        prices = []
        
        # ç”Ÿæˆæ¨¡æ‹Ÿå‡€å€¼
        np.random.seed(42)  # ç¡®ä¿ç»“æœå¯å¤ç°
        for i in range(len(dates)):
            # éšæœºæ¯æ—¥å›æŠ¥ç‡
            daily_return = np.random.normal(0.0005, 0.01)  # å‡å€¼çº¦12%å¹´åŒ–ï¼Œæ³¢åŠ¨çº¦16%å¹´åŒ–
            
            # æ·»åŠ æ³¢åŠ¨ç‰¹å¾
            if i > 30:
                # æ·»åŠ å‘¨æœŸæ€§æ³¢åŠ¨
                cycle = 0.005 * np.sin(i / 20)
                cycle += 0.01 * np.sin(i / 60)  # æ·»åŠ æ›´é•¿å‘¨æœŸçš„æ³¢åŠ¨
                daily_return += cycle
            
            # æ›´æ–°ä»·æ ¼
            price *= (1 + daily_return)
            prices.append(price)
        
        # åˆ›å»ºDataFrame
        df = pd.DataFrame({
            'date': dates,
            'value': prices
        })
        
        # ä¿å­˜åˆ°æ–‡ä»¶
        df.to_csv(self.get_data_file_path(), index=False)
        
        # ä¿å­˜æ¨¡æ‹ŸåŸºé‡‘ä¿¡æ¯
        fund_info = {
            "fund_id": self.fund_id,
            "fund_name": f"æ¨¡æ‹ŸåŸºé‡‘{self.fund_id}",
            "establish_date": start_date.strftime('%Y-%m-%d')
        }
        
        with open(self.get_fund_info_path(), 'w', encoding='utf-8') as f:
            json.dump(fund_info, f, ensure_ascii=False, indent=4)
        
        self.fund_info = fund_info
        print(f"å·²åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®ï¼Œæ—¶é—´èŒƒå›´: {dates[0].date()} åˆ° {dates[-1].date()}")
        
        return df
    
    def load_fund_data(self, refresh: bool = False):
        """
        åŠ è½½åŸºé‡‘æ•°æ®ï¼Œå¦‚æœæœ¬åœ°æ²¡æœ‰æˆ–éœ€è¦åˆ·æ–°åˆ™ä»ç½‘ç»œè·å–
        
        å‚æ•°:
            refresh: æ˜¯å¦å¼ºåˆ¶åˆ·æ–°æ•°æ®
            
        è¿”å›:
            DataFrame: åŸºé‡‘å†å²å‡€å€¼æ•°æ®
        """
        data_file = self.get_data_file_path()
        info_file = self.get_fund_info_path()
        
        # å¼ºåˆ¶åˆ·æ–°æˆ–æœ¬åœ°æ–‡ä»¶ä¸å­˜åœ¨
        if refresh or not (os.path.exists(data_file) and os.path.exists(info_file)):
            return self.fetch_fund_data()
        
        # æ£€æŸ¥æ•°æ®å’Œä¿¡æ¯æ–‡ä»¶æ˜¯å¦éƒ½å­˜åœ¨
        try:
            # åŠ è½½æ•°æ®
            df = pd.read_csv(data_file)
            df['date'] = pd.to_datetime(df['date'])
            
            # åŠ è½½åŸºé‡‘ä¿¡æ¯
            with open(info_file, 'r', encoding='utf-8') as f:
                self.fund_info = json.load(f)
            
            print(f"ä»æœ¬åœ°åŠ è½½åŸºé‡‘æ•°æ®æˆåŠŸ: {self.fund_info['fund_name']} ({self.fund_id})")
            print(f"æ•°æ®æ—¶é—´èŒƒå›´: {df['date'].min().date()} åˆ° {df['date'].max().date()}")
            
            return df
        
        except Exception as e:
            print(f"è¯»å–æœ¬åœ°æ•°æ®å‡ºé”™: {e}")
            print("å°†å°è¯•é‡æ–°è·å–æ•°æ®...")
            return self.fetch_fund_data()
    
    def run_investment_strategy(self, verbose: bool = True, save_results: bool = True) -> dict:
        """
        è¿è¡ŒæŠ•èµ„ç­–ç•¥:
        1. æ¯ä¸ªäº¤æ˜“æ—¥å®šæŠ•å›ºå®šé‡‘é¢
        2. æ”¶ç›Šç‡è¾¾åˆ°é˜ˆå€¼æ—¶å…¨éƒ¨å–å‡º
        3. å–å‡ºåç»§ç»­å®šæŠ•
        
        å‚æ•°:
            verbose: æ˜¯å¦æ‰“å°è¯¦ç»†ä¿¡æ¯
            save_results: æ˜¯å¦ä¿å­˜ç»“æœ
        
        è¿”å›:
            dict: åŒ…å«æŠ•èµ„ç»“æœçš„è¯¦ç»†æ•°æ®
        """
        if self.fund_data is None or len(self._fund_data_cache) == 0:
            self.fund_data = self.load_fund_data()
            # å°†æ•°æ®æ”¾å…¥ç¼“å­˜ï¼Œä»¥ä¾¿é‡å¤ä½¿ç”¨
            self._fund_data_cache[self.fund_id] = self.fund_data
        else:
            # ä½¿ç”¨ç¼“å­˜æ•°æ®
            self.fund_data = self._fund_data_cache[self.fund_id]
        
        if self.fund_data.empty:
            print("åŸºé‡‘æ•°æ®ä¸ºç©ºï¼Œæ— æ³•æ‰§è¡ŒæŠ•èµ„ç­–ç•¥")
            return {"total_profit": 0, "overall_return": 0}
        
        if verbose:
            print(f"\n===== å¼€å§‹æ‰§è¡ŒæŠ•èµ„ç­–ç•¥ =====")
            print(f"åŸºé‡‘: {self.fund_info['fund_name']} ({self.fund_id})")
            print(f"æ¯æ—¥å®šæŠ•é‡‘é¢: {self.investment_amount} å…ƒ")
            print(f"æ”¶ç›Šç‡é˜ˆå€¼: {self.profit_threshold*100}%")
            print(f"æŠ•èµ„æ—¶é—´èŒƒå›´: {self.fund_data['date'].min().date()} åˆ° {self.fund_data['date'].max().date()}")
        
        # é‡ç½®æŠ•èµ„çŠ¶æ€
        self.reset_investment_status()
        
        # æŒ‰æ—¥æœŸæ’åº
        self.fund_data.sort_values('date', inplace=True)
        
        # æ·»åŠ ä¹°å…¥æ—¥åˆ¤æ–­
        buy_dates = self.fund_data['date'].tolist()
        
        # åˆå§‹åŒ–æŠ•èµ„å¼€å§‹æ—¥æœŸ
        current_investment_start_date = buy_dates[0]
        
        # ä½¿ç”¨è¿›åº¦æ¡
        if verbose:
            iterator = tqdm(buy_dates, desc=f"æ‰§è¡Œ {self.profit_threshold*100}% é˜ˆå€¼ç­–ç•¥", ncols=100)
        else:
            iterator = buy_dates
        
        for current_date in iterator:
            # è·å–å½“æ—¥å‡€å€¼
            current_value_per_unit = float(self.fund_data[self.fund_data['date'] == current_date]['value'].values[0])
            
            # è¿›è¡Œå®šæŠ•
            new_units = self.investment_amount / current_value_per_unit
            self.total_investment += self.investment_amount
            self.units_held += new_units
            self.current_value = self.units_held * current_value_per_unit
            
            # è®°å½•æŠ•èµ„æ—¥æœŸ
            self.investment_dates.append(current_date)
            
            # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ”¶ç›Šé˜ˆå€¼
            if self.total_investment > 0:
                profit_percentage = (self.current_value - self.total_investment) / self.total_investment
                
                if profit_percentage >= self.profit_threshold:
                    # è®°å½•æœ¬æ¬¡æ”¶ç›Šæƒ…å†µ
                    profit = self.current_value - self.total_investment
                    
                    reset_info = {
                        'start_date': current_investment_start_date,
                        'end_date': current_date,
                        'duration_days': (current_date - current_investment_start_date).days,
                        'total_investment': self.total_investment,
                        'final_value': self.current_value,
                        'profit': profit,
                        'profit_percentage': profit_percentage * 100,
                        'annualized_return': self.calculate_annualized_return(
                            current_investment_start_date, 
                            current_date, 
                            self.total_investment, 
                            self.current_value
                        )
                    }
                    
                    self.reset_logs.append(reset_info)
                    
                    # è¾“å‡ºè¯¦æƒ…
                    if verbose and len(self.reset_logs) <= 5:  # åªæ‰“å°å‰5æ¬¡ï¼Œé¿å…è¾“å‡ºè¿‡å¤š
                        days_passed = (current_date - current_investment_start_date).days
                        print(f"\nâ­ è§¦å‘å–å‡º! {current_date.date()} - æ”¶ç›Šç‡: {profit_percentage*100:.2f}%")
                        print(f"- æŠ•èµ„æœŸé—´: {current_investment_start_date.date()} åˆ° {current_date.date()} ({days_passed}å¤©)")
                        print(f"- æŠ•èµ„é‡‘é¢: {self.total_investment:.2f}å…ƒ")
                        print(f"- æœ€ç»ˆä»·å€¼: {self.current_value:.2f}å…ƒ")
                        print(f"- å‡€æ”¶ç›Š: {profit:.2f}å…ƒ")
                        print(f"- å¹´åŒ–æ”¶ç›Šç‡: {reset_info['annualized_return']:.2f}%")
                    
                    # é‡ç½®æŠ•èµ„çŠ¶æ€
                    self.total_investment = 0
                    self.current_value = 0
                    self.units_held = 0
                    current_investment_start_date = current_date
        
        # è®¡ç®—æœ€ç»ˆæŒä»“æ”¶ç›Šæƒ…å†µ
        final_profit = 0
        final_profit_percentage = 0
        annualized_return = 0
        
        if self.total_investment > 0:
            final_date = self.fund_data['date'].max()
            final_value_per_unit = float(self.fund_data[self.fund_data['date'] == final_date]['value'].values[0])
            self.current_value = self.units_held * final_value_per_unit
            
            final_profit = self.current_value - self.total_investment
            final_profit_percentage = (final_profit / self.total_investment) * 100
            
            days_passed = (final_date - current_investment_start_date).days
            annualized_return = self.calculate_annualized_return(
                current_investment_start_date, 
                final_date, 
                self.total_investment, 
                self.current_value
            )
            
            # æœ€åä¸€æ¬¡æŒä»“ä¿¡æ¯
            final_holding = {
                'start_date': current_investment_start_date,
                'end_date': final_date,
                'duration_days': days_passed,
                'total_investment': self.total_investment,
                'final_value': self.current_value,
                'profit': final_profit,
                'profit_percentage': final_profit_percentage,
                'annualized_return': annualized_return,
                'is_current': True
            }
            
            if verbose:
                print("\nğŸ“Š å½“å‰æŒä»“çŠ¶å†µ:")
                print(f"- æŠ•èµ„æœŸé—´: {current_investment_start_date.date()} åˆ° {final_date.date()} ({days_passed}å¤©)")
                print(f"- æŠ•èµ„é‡‘é¢: {self.total_investment:.2f}å…ƒ")
                print(f"- å½“å‰ä»·å€¼: {self.current_value:.2f}å…ƒ")
                print(f"- æŒæœ‰ä»½é¢: {self.units_held:.2f}ä»½")
                print(f"- å½“å‰æ”¶ç›Š: {final_profit:.2f}å…ƒ ({final_profit_percentage:.2f}%)")
                print(f"- å¹´åŒ–æ”¶ç›Šç‡: {annualized_return:.2f}%")
        
        # ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
        summary_data = self.generate_summary_report(verbose=verbose, save=save_results)
        
        # å¦‚æœéœ€è¦ä¿å­˜ç»“æœï¼Œç”Ÿæˆå›¾è¡¨
        if save_results:
            self.plot_investment_results(threshold=self.profit_threshold)
        
        # è¿”å›æŠ•èµ„ç»“æœæ•°æ®
        return {
            "total_profit": summary_data["total_profit"],
            "overall_return": summary_data["overall_return"],
            "num_resets": summary_data["num_resets"],
            "avg_hold_days": summary_data["avg_hold_days"],
            "annualized_return": annualized_return,
            "final_profit": final_profit,
            "final_profit_percentage": final_profit_percentage,
            "threshold": self.profit_threshold
        }
    
    def calculate_annualized_return(self, start_date, end_date, investment, final_value):
        """
        è®¡ç®—å¹´åŒ–æ”¶ç›Šç‡
        
        å‚æ•°:
            start_date: æŠ•èµ„å¼€å§‹æ—¥æœŸ
            end_date: æŠ•èµ„ç»“æŸæ—¥æœŸ
            investment: æŠ•èµ„é‡‘é¢
            final_value: æœ€ç»ˆä»·å€¼
            
        è¿”å›:
            float: å¹´åŒ–æ”¶ç›Šç‡(ç™¾åˆ†æ¯”)
        """
        years = (end_date - start_date).days / 365
        if years <= 0 or investment <= 0:
            return 0
            
        # è®¡ç®—å¹´åŒ–æ”¶ç›Šç‡
        return ((final_value / investment) ** (1 / years) - 1) * 100
    
    def generate_summary_report(self, verbose: bool = True, save: bool = True) -> Dict[str, Any]:
        """
        ç”ŸæˆæŠ•èµ„æ±‡æ€»æŠ¥å‘Š
        
        å‚æ•°:
            verbose: æ˜¯å¦æ‰“å°è¯¦ç»†ä¿¡æ¯
            save: æ˜¯å¦ä¿å­˜ç»“æœåˆ°æ–‡ä»¶
            
        è¿”å›:
            dict: åŒ…å«æ±‡æ€»æ•°æ®çš„å­—å…¸
        """
        if not self.reset_logs and self.total_investment <= 0:
            if verbose:
                print("\næ²¡æœ‰æŠ•èµ„è®°å½•ï¼Œæ— æ³•ç”ŸæˆæŠ¥å‘Š")
            return {"total_profit": 0, "overall_return": 0, "num_resets": 0, "avg_hold_days": 0}
        
        # è®¡ç®—æ€»ç»Ÿè®¡æ•°æ®
        total_profit = 0
        total_days = 0
        total_investments = 0
        num_resets = len(self.reset_logs)
        
        # è®¡ç®—å·²å®ç°æ”¶ç›Š
        for reset in self.reset_logs:
            total_profit += reset['profit']
            total_days += reset['duration_days']
            total_investments += reset['total_investment']
        
        # åŠ ä¸Šå½“å‰æŒä»“
        current_profit = 0
        if self.total_investment > 0:
            current_profit = self.current_value - self.total_investment
            total_profit += current_profit
            
            # è·å–æœ€åä¸€æ¬¡æŠ•èµ„æ—¥æœŸ
            if self.investment_dates:
                last_start_date = max([r['start_date'] for r in self.reset_logs]) if self.reset_logs else self.investment_dates[0]
                total_days += (self.investment_dates[-1] - last_start_date).days
            
            total_investments += self.total_investment
        
        # è®¡ç®—æ€»æ”¶ç›Šç‡
        overall_return = (total_profit / total_investments) * 100 if total_investments > 0 else 0
        
        # è®¡ç®—å¹³å‡æŒæœ‰å¤©æ•°
        avg_hold_days = total_days / (num_resets + 1) if (num_resets > 0 or self.total_investment > 0) else 0
        
        # ç”ŸæˆæŠ¥å‘Š
        report = []
        report.append(f"====== æŠ•èµ„ç­–ç•¥æ±‡æ€»æŠ¥å‘Š ({self.profit_threshold*100}% é˜ˆå€¼) ======")
        report.append(f"åŸºé‡‘åç§°: {self.fund_info['fund_name']} ({self.fund_id})")
        report.append(f"æŠ•èµ„ç­–ç•¥: æ¯æ—¥å®šæŠ• {self.investment_amount}å…ƒï¼Œæ”¶ç›Šè¾¾åˆ° {self.profit_threshold*100}% å–å‡º")
        report.append(f"æŠ•èµ„æœŸé—´: {self.fund_data['date'].min().date()} åˆ° {self.fund_data['date'].max().date()}")
        report.append(f"å–å‡ºæ¬¡æ•°: {num_resets} æ¬¡")
        report.append(f"æ€»æŠ•èµ„é‡‘é¢: {total_investments:.2f} å…ƒ")
        report.append(f"æ€»æ”¶ç›Š: {total_profit:.2f} å…ƒ ({overall_return:.2f}%)")
        report.append(f"å¹³å‡æŒæœ‰å¤©æ•°: {avg_hold_days:.1f} å¤©")
        
        # æ·»åŠ æ¯æ¬¡å–å‡ºçš„è¯¦ç»†ä¿¡æ¯
        if self.reset_logs:
            report.append("\n==== å†å²å–å‡ºè®°å½• ====")
            for i, reset in enumerate(self.reset_logs, 1):
                if i <= 10 or i > len(self.reset_logs) - 3:  # åªæ˜¾ç¤ºå‰10æ¬¡å’Œæœ€å3æ¬¡
                    report.append(f"\nå–å‡º #{i} ({reset['end_date'].date()}):")
                    report.append(f"- æŠ•èµ„æœŸé—´: {reset['start_date'].date()} åˆ° {reset['end_date'].date()} ({reset['duration_days']}å¤©)")
                    report.append(f"- æŠ•èµ„é‡‘é¢: {reset['total_investment']:.2f}å…ƒ")
                    report.append(f"- å–å‡ºä»·å€¼: {reset['final_value']:.2f}å…ƒ")
                    report.append(f"- å‡€æ”¶ç›Š: {reset['profit']:.2f}å…ƒ ({reset['profit_percentage']:.2f}%)")
                    report.append(f"- å¹´åŒ–æ”¶ç›Šç‡: {reset['annualized_return']:.2f}%")
                elif i == 11 and len(self.reset_logs) > 13:
                    report.append(f"\n... çœç•¥ {len(self.reset_logs) - 13} æ¬¡å–å‡ºè®°å½• ...")
        
        # æ·»åŠ å½“å‰æŒä»“ä¿¡æ¯
        if self.total_investment > 0:
            final_date = self.fund_data['date'].max()
            final_profit = self.current_value - self.total_investment
            final_profit_percentage = (final_profit / self.total_investment) * 100
            
            # æ‰¾å‡ºæœ€åä¸€æ¬¡å¼€å§‹æŠ•èµ„çš„æ—¥æœŸ
            last_start_date = max([r['start_date'] for r in self.reset_logs]) if self.reset_logs else self.investment_dates[0]
            days_passed = (final_date - last_start_date).days
            
            annualized_return = self.calculate_annualized_return(
                last_start_date, 
                final_date, 
                self.total_investment, 
                self.current_value
            )
            
            report.append("\n==== å½“å‰æŒä»“æƒ…å†µ ====")
            report.append(f"- æŠ•èµ„æœŸé—´: {last_start_date.date()} åˆ° {final_date.date()} ({days_passed}å¤©)")
            report.append(f"- æŠ•èµ„é‡‘é¢: {self.total_investment:.2f}å…ƒ")
            report.append(f"- å½“å‰ä»·å€¼: {self.current_value:.2f}å…ƒ")
            report.append(f"- æŒæœ‰ä»½é¢: {self.units_held:.2f}ä»½")
            report.append(f"- å½“å‰æ”¶ç›Š: {final_profit:.2f}å…ƒ ({final_profit_percentage:.2f}%)")
            report.append(f"- å¹´åŒ–æ”¶ç›Šç‡: {annualized_return:.2f}%")
        
        report_text = '\n'.join(report)
        
        # æ‰“å°æŠ¥å‘Š
        if verbose:
            print("\n" + report_text)
        
        # ä¿å­˜æŠ¥å‘Š
        if save:
            results_path = self.get_results_file_path("txt", threshold=self.profit_threshold)
            with open(results_path, 'w', encoding='utf-8') as f:
                f.write(report_text)
            
            print(f"æŠ•èµ„æ±‡æ€»æŠ¥å‘Šå·²ä¿å­˜è‡³: {results_path}")
        
        # è¿”å›æ±‡æ€»æ•°æ®
        return {
            "total_profit": total_profit,
            "overall_return": overall_return,
            "num_resets": num_resets,
            "avg_hold_days": avg_hold_days,
            "total_investments": total_investments,
            "current_profit": current_profit,
            "detailed_report": report_text
        }
    
    def plot_investment_results(self, threshold: Optional[float] = None):
        """
        ç»˜åˆ¶æŠ•èµ„ç»“æœå›¾è¡¨
        
        å‚æ•°:
            threshold: æ”¶ç›Šç‡é˜ˆå€¼ï¼Œç”¨äºç”Ÿæˆç‰¹å®šé˜ˆå€¼çš„æ–‡ä»¶å
        """
        if not self.reset_logs and self.total_investment <= 0:
            print("æ²¡æœ‰æŠ•èµ„æ•°æ®ï¼Œæ— æ³•ç”Ÿæˆå›¾è¡¨")
            return
        
        # è®¾ç½®é˜ˆå€¼æ ‡ç­¾
        threshold = threshold or self.profit_threshold
        threshold_label = f"{threshold*100}%"
            
        # è®¾ç½®å›¾è¡¨å¤§å°
        plt.figure(figsize=(12, 10))
        
        # ç»˜åˆ¶åŸºé‡‘å‡€å€¼èµ°åŠ¿
        plt.subplot(2, 1, 1)
        plt.plot(self.fund_data['date'], self.fund_data['value'], 'b-', label='åŸºé‡‘å‡€å€¼')
        
        # æ ‡è®°å–å‡ºç‚¹
        for reset in self.reset_logs:
            plt.axvline(x=reset['end_date'], color='r', linestyle='--', alpha=0.7)
            plt.scatter(reset['end_date'], self.fund_data[self.fund_data['date'] == reset['end_date']]['value'].values[0], 
                     color='red', s=80, marker='v', zorder=5)
            
            # æ·»åŠ æ”¶ç›Šç‡æ ‡æ³¨
            plt.annotate(f"{reset['profit_percentage']:.1f}%", 
                      (reset['end_date'], self.fund_data[self.fund_data['date'] == reset['end_date']]['value'].values[0]),
                      xytext=(0, -30), textcoords='offset points',
                      ha='center', va='center',
                      bbox=dict(boxstyle='round,pad=0.5', fc='yellow', alpha=0.7))
        
        plt.title(f"{self.fund_info['fund_name']} ({self.fund_id}) - {threshold_label} é˜ˆå€¼ç­–ç•¥", fontsize=14)
        plt.ylabel("å‡€å€¼", fontsize=12)
        plt.grid(True, alpha=0.3)
        plt.legend(loc='best')
        
        # ç»˜åˆ¶æ¯æ¬¡æŠ•èµ„å‘¨æœŸçš„æ”¶ç›Šç‡å’ŒæŒæœ‰å¤©æ•°
        plt.subplot(2, 1, 2)
        
        # ç»„åˆæ•°æ®
        all_cycles = []
        for reset in self.reset_logs:
            all_cycles.append({
                'end_date': reset['end_date'],
                'profit_percentage': reset['profit_percentage'],
                'duration': reset['duration_days'],
                'is_current': False
            })
        
        # æ·»åŠ å½“å‰æŒä»“
        if self.total_investment > 0:
            final_date = self.fund_data['date'].max()
            last_start_date = max([r['start_date'] for r in self.reset_logs]) if self.reset_logs else self.investment_dates[0]
            days_passed = (final_date - last_start_date).days
            
            current_profit_percentage = ((self.current_value - self.total_investment) / self.total_investment) * 100
            
            all_cycles.append({
                'end_date': final_date,
                'profit_percentage': current_profit_percentage,
                'duration': days_passed,
                'is_current': True
            })
        
        if not all_cycles:  # å¦‚æœæ²¡æœ‰æŠ•èµ„å‘¨æœŸæ•°æ®
            plt.text(0.5, 0.5, 'æ— æŠ•èµ„å‘¨æœŸæ•°æ®', ha='center', va='center', transform=plt.gca().transAxes)
        else:
            # æå–æ•°æ®
            dates = [cycle['end_date'] for cycle in all_cycles]
            profit_percentages = [cycle['profit_percentage'] for cycle in all_cycles]
            durations = [cycle['duration'] for cycle in all_cycles]
            is_current = [cycle['is_current'] for cycle in all_cycles]
            
            # åˆ›å»ºæ¨ªæ¡å›¾è¡¨ç¤ºæŒæœ‰å¤©æ•°
            ax1 = plt.gca()
            ax1.bar(dates, durations, width=10, color=['blue' if not current else 'green' for current in is_current], 
                   alpha=0.6, label='æŒæœ‰å¤©æ•°')
            ax1.set_ylabel("æŒæœ‰å¤©æ•°", fontsize=12)
            
            # åˆ›å»ºæŠ˜çº¿å›¾è¡¨ç¤ºæ”¶ç›Šç‡
            ax2 = ax1.twinx()
            ax2.plot(dates, profit_percentages, 'ro-', label='æ”¶ç›Šç‡(%)')
            
            # æ ‡è®°é˜ˆå€¼çº¿
            ax2.axhline(y=threshold*100, color='r', linestyle='--', alpha=0.7, 
                       label=f"ç›®æ ‡æ”¶ç›Šç‡ {threshold_label}")
            
            # æ·»åŠ æ”¶ç›Šç‡æ ‡ç­¾
            for i, (date, profit) in enumerate(zip(dates, profit_percentages)):
                ax2.annotate(f"{profit:.1f}%", 
                          (date, profit),
                          xytext=(0, 10), textcoords='offset points',
                          ha='center', va='bottom')
            
            # è®¾ç½®æ ‡é¢˜å’Œæ ‡ç­¾
            plt.title(f"å„å‘¨æœŸæ”¶ç›Šç‡å’ŒæŒæœ‰å¤©æ•° (é˜ˆå€¼: {threshold_label})", fontsize=14)
            ax2.set_ylabel("æ”¶ç›Šç‡ (%)", fontsize=12)
            plt.xlabel("æ—¥æœŸ", fontsize=12)
            plt.grid(True, alpha=0.3)
            
            # åˆå¹¶å›¾ä¾‹
            lines1, labels1 = ax1.get_legend_handles_labels()
            lines2, labels2 = ax2.get_legend_handles_labels()
            ax2.legend(lines1 + lines2, labels1 + labels2, loc='best')
        
        # è°ƒæ•´å¸ƒå±€
        plt.tight_layout()
        
        # ä¿å­˜å›¾è¡¨
        results_path = self.get_results_file_path("png", threshold=threshold)
        plt.savefig(results_path, dpi=300)
        print(f"æŠ•èµ„ç»“æœå›¾è¡¨å·²ä¿å­˜è‡³: {results_path}")
        
        plt.close()


def analyze_multiple_thresholds(fund_id: str, investment_amount: float = 200, 
                                min_threshold: float = 0.1, max_threshold: float = 1.0, 
                                step: float = 0.1, refresh_data: bool = False,
                                precision: int = 2) -> Dict:
    """
    åˆ†æå¤šä¸ªæ”¶ç›Šé˜ˆå€¼çš„æŠ•èµ„æ•ˆæœï¼Œå¹¶æ‰¾å‡ºæ”¶ç›Šæœ€é«˜çš„é˜ˆå€¼
    
    å‚æ•°:
        fund_id: åŸºé‡‘ä»£ç 
        investment_amount: æ¯æ¬¡å®šæŠ•é‡‘é¢
        min_threshold: æœ€å°æ”¶ç›Šé˜ˆå€¼
        max_threshold: æœ€å¤§æ”¶ç›Šé˜ˆå€¼
        step: é˜ˆå€¼æ­¥é•¿
        refresh_data: æ˜¯å¦åˆ·æ–°åŸºé‡‘æ•°æ®
        precision: ç²¾åº¦ï¼Œåœ¨æ‰¾åˆ°æœ€ä½³é˜ˆå€¼åï¼Œè¿›ä¸€æ­¥ç»†åŒ–æœç´¢çš„ç²¾åº¦
    
    è¿”å›:
        dict: å„é˜ˆå€¼çš„åˆ†æç»“æœå’Œæœ€ä½³é˜ˆå€¼
    """
    print(f"\n===== å¼€å§‹åˆ†æä¸åŒæ”¶ç›Šé˜ˆå€¼çš„æŠ•èµ„æ•ˆæœ =====")
    print(f"åŸºé‡‘ID: {fund_id}")
    print(f"æ¯æ—¥å®šæŠ•é‡‘é¢: {investment_amount}å…ƒ")
    print(f"é˜ˆå€¼èŒƒå›´: {min_threshold*100}% åˆ° {max_threshold*100}% (æ­¥é•¿: {step*100}%)")
    
    # ç”Ÿæˆå¾…æµ‹è¯•é˜ˆå€¼åˆ—è¡¨
    thresholds = np.arange(min_threshold, max_threshold + step/2, step)  # æ·»åŠ step/2æ˜¯ä¸ºäº†è§£å†³æµ®ç‚¹æ•°è¯¯å·®
    thresholds = [round(t, 2) for t in thresholds]  # å››èˆäº”å…¥åˆ°2ä½å°æ•°
    
    results = {}
    
    # ç¬¬ä¸€æ¬¡åˆ›å»ºå¯¹è±¡æ—¶è¯»å–æˆ–è·å–æ•°æ®
    first_analysis = FundInvestment(fund_id, investment_amount, thresholds[0])
    first_analysis.fund_data = first_analysis.load_fund_data(refresh=refresh_data)
    
    # ä½¿ç”¨è¿›åº¦æ¡æ˜¾ç¤ºåˆ†æè¿›åº¦
    with tqdm(total=len(thresholds), desc="é˜ˆå€¼åˆ†æè¿›åº¦ (ç¬¬1è½®)", ncols=100) as pbar:
        for threshold in thresholds:
            # ä½¿ç”¨ç¼“å­˜çš„æ•°æ®åˆ›å»ºæ–°çš„åˆ†æå¯¹è±¡
            analysis = FundInvestment(fund_id, investment_amount, threshold)
            analysis._fund_data_cache = {fund_id: first_analysis.fund_data}
            analysis.fund_info = first_analysis.fund_info
            
            # æ‰§è¡ŒæŠ•èµ„ç­–ç•¥åˆ†æ
            result_data = analysis.run_investment_strategy(verbose=False)
            
            # è®°å½•ç»“æœ
            results[threshold] = result_data
            
            pbar.update(1)
    
    # æ‰¾å‡ºæ”¶ç›Šæœ€é«˜çš„é˜ˆå€¼
    best_threshold = max(results.items(), key=lambda x: x[1]["total_profit"])[0]
    best_result = results[best_threshold]
    
    # å¦‚æœéœ€è¦æ›´é«˜ç²¾åº¦ï¼Œåœ¨æœ€ä½³é˜ˆå€¼é™„è¿‘è¿›ä¸€æ­¥æœç´¢
    if precision > 0:
        refined_min = max(min_threshold, best_threshold - step)
        refined_max = min(max_threshold, best_threshold + step)
        refined_step = step / 5  # ä½¿ç”¨æ›´å°çš„æ­¥é•¿
        
        refined_thresholds = np.arange(refined_min, refined_max + refined_step/2, refined_step)
        refined_thresholds = [round(t, 3) for t in refined_thresholds if t != best_threshold]  # æ›´é«˜ç²¾åº¦ï¼Œæ’é™¤å·²æµ‹è¯•çš„é˜ˆå€¼
        
        print(f"\nåœ¨ {refined_min*100}% åˆ° {refined_max*100}% èŒƒå›´å†…è¿›ä¸€æ­¥ç²¾ç¡®æœç´¢æœ€ä½³é˜ˆå€¼...")
        
        # ç¬¬äºŒè½®æœç´¢
        with tqdm(total=len(refined_thresholds), desc="é˜ˆå€¼åˆ†æè¿›åº¦ (ç¬¬2è½®)", ncols=100) as pbar:
            for threshold in refined_thresholds:
                analysis = FundInvestment(fund_id, investment_amount, threshold)
                analysis._fund_data_cache = {fund_id: first_analysis.fund_data}
                analysis.fund_info = first_analysis.fund_info
                
                result_data = analysis.run_investment_strategy(verbose=False)
                results[threshold] = result_data
                
                if result_data["total_profit"] > best_result["total_profit"]:
                    best_threshold = threshold
                    best_result = result_data
                
                pbar.update(1)
    
    # è¾“å‡ºæ‰€æœ‰é˜ˆå€¼çš„ç»“æœè¡¨æ ¼
    print("\n===== ä¸åŒé˜ˆå€¼åˆ†æç»“æœ =====")
    print("é˜ˆå€¼\tæ€»æ”¶ç›Š(å…ƒ)\tæ”¶ç›Šç‡(%)\tå–å‡ºæ¬¡æ•°\tå¹³å‡æŒæœ‰å¤©æ•°\tå¹´åŒ–æ”¶ç›Š(%)")
    print("-" * 80)
    
    # æŒ‰é˜ˆå€¼æ’åºå¹¶æ‰“å°
    sorted_results = sorted(results.items())
    for threshold, data in sorted_results:
        print(f"{threshold*100:5.1f}%\t{data['total_profit']:10.2f}\t{data['overall_return']:8.2f}%\t{data['num_resets']:8d}\t{data['avg_hold_days']:12.1f}\t{data.get('annualized_return', 0):12.2f}%")
    
    print("\n===== æœ€ä½³é˜ˆå€¼ =====")
    print(f"ğŸ† æ”¶ç›Šæœ€é«˜é˜ˆå€¼: {best_threshold*100:.1f}%")
    print(f"æ€»æ”¶ç›Š: {best_result['total_profit']:.2f}å…ƒ")
    print(f"æ”¶ç›Šç‡: {best_result['overall_return']:.2f}%")
    print(f"å–å‡ºæ¬¡æ•°: {best_result['num_resets']}")
    print(f"å¹³å‡æŒæœ‰å¤©æ•°: {best_result['avg_hold_days']:.1f}")
    if 'annualized_return' in best_result:
        print(f"å¹´åŒ–æ”¶ç›Šç‡: {best_result['annualized_return']:.2f}%")
    
    # ä¿å­˜ç»“æœä¸ºCSV
    df = pd.DataFrame([
        {
            "threshold": t*100,
            "total_profit": data["total_profit"],
            "overall_return": data["overall_return"],
            "num_resets": data["num_resets"],
            "avg_hold_days": data["avg_hold_days"],
            "annualized_return": data.get("annualized_return", 0)
        }
        for t, data in results.items()
    ])
    
    results_path = os.path.join("investment_results", f"fund_{fund_id}_threshold_comparison.csv")
    df.to_csv(results_path, index=False)
    print(f"\nå„é˜ˆå€¼å¯¹æ¯”ç»“æœå·²ä¿å­˜è‡³: {results_path}")
    
    # ç»˜åˆ¶å¯¹æ¯”å›¾
    plot_threshold_comparison(fund_id, results)
    
    # å¯¹æœ€ä½³é˜ˆå€¼ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
    print("\nä¸ºæœ€ä½³é˜ˆå€¼ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š...")
    best_analysis = FundInvestment(fund_id, investment_amount, best_threshold)
    best_analysis._fund_data_cache = {fund_id: first_analysis.fund_data}
    best_analysis.fund_info = first_analysis.fund_info
    best_analysis.run_investment_strategy(verbose=True)
    
    return {
        "results": results,
        "best_threshold": best_threshold,
        "best_result": best_result
    }


def plot_threshold_comparison(fund_id: str, results: Dict):
    """
    ç»˜åˆ¶ä¸åŒé˜ˆå€¼æ•ˆæœå¯¹æ¯”å›¾
    
    å‚æ•°:
        fund_id: åŸºé‡‘ä»£ç 
        results: å„é˜ˆå€¼çš„åˆ†æç»“æœ
    """
    # æå–æ•°æ®
    sorted_results = sorted(results.items())
    thresholds = [k*100 for k, _ in sorted_results]  # è½¬æ¢ä¸ºç™¾åˆ†æ¯”å½¢å¼
    profits = [v["total_profit"] for _, v in sorted_results]
    returns = [v["overall_return"] for _, v in sorted_results]
    num_resets = [v["num_resets"] for _, v in sorted_results]
    avg_hold_days = [v["avg_hold_days"] for _, v in sorted_results]
    
    # æ‰¾å‡ºæœ€ä½³é˜ˆå€¼
    best_idx = profits.index(max(profits))
    
    # åˆ›å»ºå›¾è¡¨
    fig, axes = plt.subplots(2, 2, figsize=(16, 12))
    
    # 1. ç»˜åˆ¶æ€»æ”¶ç›Šå¯¹æ¯”
    bars1 = axes[0, 0].bar(range(len(thresholds)), profits, color=['royalblue' if i != best_idx else 'gold' for i in range(len(thresholds))])
    axes[0, 0].set_ylabel('æ€»æ”¶ç›Š (å…ƒ)', fontsize=12)
    axes[0, 0].set_title('ä¸åŒé˜ˆå€¼çš„æ€»æ”¶ç›Šå¯¹æ¯”', fontsize=14)
    axes[0, 0].set_xticks(range(len(thresholds)))
    axes[0, 0].set_xticklabels([f"{t}%" for t in thresholds], rotation=45)
    axes[0, 0].grid(axis='y', alpha=0.3)
    
    # æ·»åŠ æ”¶ç›Šæ•°å€¼æ ‡ç­¾
    for bar in bars1:
        height = bar.get_height()
        axes[0, 0].annotate(f'{height:.2f}',
                         xy=(bar.get_x() + bar.get_width() / 2, height),
                         xytext=(0, 3),
                         textcoords="offset points",
                         ha='center', va='bottom',
                         fontsize=9)
    
    # 2. ç»˜åˆ¶æ”¶ç›Šç‡å¯¹æ¯”
    bars2 = axes[0, 1].bar(range(len(thresholds)), returns, color=['green' if i != best_idx else 'gold' for i in range(len(thresholds))])
    axes[0, 1].set_ylabel('æ”¶ç›Šç‡ (%)', fontsize=12)
    axes[0, 1].set_title('ä¸åŒé˜ˆå€¼çš„æ”¶ç›Šç‡å¯¹æ¯”', fontsize=14)
    axes[0, 1].set_xticks(range(len(thresholds)))
    axes[0, 1].set_xticklabels([f"{t}%" for t in thresholds], rotation=45)
    axes[0, 1].grid(axis='y', alpha=0.3)
    
    # æ·»åŠ æ”¶ç›Šç‡æ•°å€¼æ ‡ç­¾
    for bar in bars2:
        height = bar.get_height()
        axes[0, 1].annotate(f'{height:.2f}%',
                         xy=(bar.get_x() + bar.get_width() / 2, height),
                         xytext=(0, 3),
                         textcoords="offset points",
                         ha='center', va='bottom',
                         fontsize=9)
    
    # 3. ç»˜åˆ¶å–å‡ºæ¬¡æ•°å¯¹æ¯”
    bars3 = axes[1, 0].bar(range(len(thresholds)), num_resets, color=['purple' if i != best_idx else 'gold' for i in range(len(thresholds))])
    axes[1, 0].set_ylabel('å–å‡ºæ¬¡æ•°', fontsize=12)
    axes[1, 0].set_title('ä¸åŒé˜ˆå€¼çš„å–å‡ºæ¬¡æ•°å¯¹æ¯”', fontsize=14)
    axes[1, 0].set_xlabel('æ”¶ç›Šé˜ˆå€¼', fontsize=12)
    axes[1, 0].set_xticks(range(len(thresholds)))
    axes[1, 0].set_xticklabels([f"{t}%" for t in thresholds], rotation=45)
    axes[1, 0].grid(axis='y', alpha=0.3)
    
    # æ·»åŠ å–å‡ºæ¬¡æ•°æ ‡ç­¾
    for bar in bars3:
        height = bar.get_height()
        axes[1, 0].annotate(f'{height:.0f}',
                         xy=(bar.get_x() + bar.get_width() / 2, height),
                         xytext=(0, 3),
                         textcoords="offset points",
                         ha='center', va='bottom',
                         fontsize=9)
    
    # 4. ç»˜åˆ¶å¹³å‡æŒæœ‰å¤©æ•°å¯¹æ¯”
    bars4 = axes[1, 1].bar(range(len(thresholds)), avg_hold_days, color=['orange' if i != best_idx else 'gold' for i in range(len(thresholds))])
    axes[1, 1].set_ylabel('å¹³å‡æŒæœ‰å¤©æ•°', fontsize=12)
    axes[1, 1].set_title('ä¸åŒé˜ˆå€¼çš„å¹³å‡æŒæœ‰å¤©æ•°å¯¹æ¯”', fontsize=14)
    axes[1, 1].set_xlabel('æ”¶ç›Šé˜ˆå€¼', fontsize=12)
    axes[1, 1].set_xticks(range(len(thresholds)))
    axes[1, 1].set_xticklabels([f"{t}%" for t in thresholds], rotation=45)
    axes[1, 1].grid(axis='y', alpha=0.3)
    
    # æ·»åŠ å¹³å‡æŒæœ‰å¤©æ•°æ ‡ç­¾
    for bar in bars4:
        height = bar.get_height()
        axes[1, 1].annotate(f'{height:.1f}',
                         xy=(bar.get_x() + bar.get_width() / 2, height),
                         xytext=(0, 3),
                         textcoords="offset points",
                         ha='center', va='bottom',
                         fontsize=9)
    
    # æ·»åŠ æ•´ä½“æ ‡é¢˜
    plt.suptitle(f'åŸºé‡‘ {fund_id} - ä¸åŒé˜ˆå€¼æŠ•èµ„ç­–ç•¥å¯¹æ¯”åˆ†æ\næœ€ä½³é˜ˆå€¼: {thresholds[best_idx]}%', fontsize=16)
    
    # è°ƒæ•´å¸ƒå±€
    plt.tight_layout(rect=[0, 0, 1, 0.95])
    
    # ä¿å­˜å›¾è¡¨
    results_path = os.path.join("investment_results", f"fund_{fund_id}_threshold_comparison.png")
    plt.savefig(results_path, dpi=300)
    print(f"é˜ˆå€¼å¯¹æ¯”å›¾å·²ä¿å­˜è‡³: {results_path}")
    
    plt.close()


def find_optimal_thresholds(fund_id: str, investment_amount: float = 200, 
                           refresh_data: bool = False):
    """
    æ‰¾å‡ºåŸºé‡‘çš„æœ€ä½³æ”¶ç›Šé˜ˆå€¼
    
    å‚æ•°:
        fund_id: åŸºé‡‘ä»£ç 
        investment_amount: æ¯æ¬¡å®šæŠ•é‡‘é¢
        refresh_data: æ˜¯å¦åˆ·æ–°åŸºé‡‘æ•°æ®
        
    æ‰§è¡Œä¸‰è½®æœç´¢:
    1. ç²—æœç´¢: 10% åˆ° 100%ï¼Œæ­¥é•¿ 10%
    2. ä¸­æœç´¢: åœ¨ç²—æœç´¢æœ€ä½³é˜ˆå€¼é™„è¿‘ï¼Œæ­¥é•¿ 2%
    3. ç²¾æœç´¢: åœ¨ä¸­æœç´¢æœ€ä½³é˜ˆå€¼é™„è¿‘ï¼Œæ­¥é•¿ 0.5%
    """
    print(f"===== å¼€å§‹å¯»æ‰¾åŸºé‡‘ {fund_id} çš„æœ€ä½³æ”¶ç›Šé˜ˆå€¼ =====")
    
    # ç¬¬ä¸€è½®: ç²—æœç´¢ (10%-100%, æ­¥é•¿10%)
    print("\nğŸ” ç¬¬ä¸€è½®: ç²—æœç´¢ (10%-100%, æ­¥é•¿10%)")
    first_round = analyze_multiple_thresholds(
        fund_id=fund_id,
        investment_amount=investment_amount,
        min_threshold=0.1,
        max_threshold=1.0,
        step=0.1,
        refresh_data=refresh_data,
        precision=0  # ä¸è¿›è¡Œé¢å¤–ç²¾ç¡®æœç´¢
    )
    
    best_threshold_1 = first_round["best_threshold"]
    
    # ç¬¬äºŒè½®: ä¸­æœç´¢ (æœ€ä½³é˜ˆå€¼Â±15%, æ­¥é•¿2%)
    min_threshold_2 = max(0.05, best_threshold_1 - 0.15)
    max_threshold_2 = min(1.0, best_threshold_1 + 0.15)
    
    print(f"\nğŸ” ç¬¬äºŒè½®: ä¸­æœç´¢ ({min_threshold_2*100:.0f}%-{max_threshold_2*100:.0f}%, æ­¥é•¿2%)")
    second_round = analyze_multiple_thresholds(
        fund_id=fund_id,
        investment_amount=investment_amount,
        min_threshold=min_threshold_2,
        max_threshold=max_threshold_2,
        step=0.02,
        refresh_data=False,  # ä½¿ç”¨ç¼“å­˜æ•°æ®
        precision=0  # ä¸è¿›è¡Œé¢å¤–ç²¾ç¡®æœç´¢
    )
    
    best_threshold_2 = second_round["best_threshold"]
    
    # ç¬¬ä¸‰è½®: ç²¾æœç´¢ (æœ€ä½³é˜ˆå€¼Â±3%, æ­¥é•¿0.5%)
    min_threshold_3 = max(0.01, best_threshold_2 - 0.03)
    max_threshold_3 = min(1.0, best_threshold_2 + 0.03)
    
    print(f"\nğŸ” ç¬¬ä¸‰è½®: ç²¾æœç´¢ ({min_threshold_3*100:.1f}%-{max_threshold_3*100:.1f}%, æ­¥é•¿0.5%)")
    third_round = analyze_multiple_thresholds(
        fund_id=fund_id,
        investment_amount=investment_amount,
        min_threshold=min_threshold_3,
        max_threshold=max_threshold_3,
        step=0.005,
        refresh_data=False,  # ä½¿ç”¨ç¼“å­˜æ•°æ®
        precision=0  # ä¸è¿›è¡Œé¢å¤–ç²¾ç¡®æœç´¢
    )
    
    final_best_threshold = third_round["best_threshold"]
    final_best_result = third_round["best_result"]
    
    # æ•´ç†æ‰€æœ‰æœç´¢ç»“æœ
    all_results = {}
    all_results.update(first_round["results"])
    all_results.update(second_round["results"])
    all_results.update(third_round["results"])
    
    # åˆ›å»ºæœ€ç»ˆæ±‡æ€»å›¾è¡¨
    plot_threshold_comparison(fund_id, all_results)
    
    print("\n===== åŸºé‡‘æœ€ä½³æ”¶ç›Šé˜ˆå€¼æœç´¢å®Œæˆ =====")
    print(f"ğŸ† æœ€ç»ˆæœ€ä½³é˜ˆå€¼: {final_best_threshold*100:.2f}%")
    print(f"æ€»æ”¶ç›Š: {final_best_result['total_profit']:.2f}å…ƒ")
    print(f"æ”¶ç›Šç‡: {final_best_result['overall_return']:.2f}%")
    print(f"å–å‡ºæ¬¡æ•°: {final_best_result['num_resets']}")
    print(f"å¹³å‡æŒæœ‰å¤©æ•°: {final_best_result['avg_hold_days']:.1f}")
    
    # å°†æ‰€æœ‰ç»“æœä¿å­˜ä¸ºCSV
    df = pd.DataFrame([
        {
            "threshold": t*100,
            "total_profit": data["total_profit"],
            "overall_return": data["overall_return"],
            "num_resets": data["num_resets"],
            "avg_hold_days": data["avg_hold_days"],
            "annualized_return": data.get("annualized_return", 0)
        }
        for t, data in sorted(all_results.items())
    ])
    
    results_path = os.path.join("investment_results", f"fund_{fund_id}_all_thresholds.csv")
    df.to_csv(results_path, index=False)
    print(f"\næ‰€æœ‰é˜ˆå€¼åˆ†æç»“æœå·²ä¿å­˜è‡³: {results_path}")
    
    # ç”Ÿæˆæœ€ä½³é˜ˆå€¼çš„è¯¦ç»†æŠ¥å‘Š
    print("\nä¸ºæœ€ç»ˆæœ€ä½³é˜ˆå€¼ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š...")
    best_analysis = FundInvestment(fund_id, investment_amount, final_best_threshold)
    
    # ä½¿ç”¨ç¼“å­˜æ•°æ®
    first_obj = FundInvestment(fund_id, investment_amount, 0.1)
    first_obj.fund_data = first_obj.load_fund_data(refresh=False)
    best_analysis._fund_data_cache = {fund_id: first_obj.fund_data}
    best_analysis.fund_info = first_obj.fund_info
    
    best_analysis.run_investment_strategy(verbose=True)
    
    return final_best_threshold


def main():
    """ä¸»å‡½æ•°"""
    
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    parser = argparse.ArgumentParser(description="åŸºé‡‘å®šæŠ•æ”¶ç›Šåˆ†æå·¥å…·")
    parser.add_argument('--fund-id', type=str, default='004997', help='åŸºé‡‘ID')
    parser.add_argument('--amount', type=float, default=200, help='æ¯æ¬¡å®šæŠ•é‡‘é¢(å…ƒ)')
    parser.add_argument('--threshold', type=float, help='æ”¶ç›Šç‡é˜ˆå€¼(ç™¾åˆ†æ¯”)ï¼Œä¸æŒ‡å®šåˆ™æ‰§è¡Œæœ€ä½³é˜ˆå€¼æœç´¢')
    parser.add_argument('--refresh', action='store_true', help='å¼ºåˆ¶åˆ·æ–°åŸºé‡‘æ•°æ®')
    parser.add_argument('--optimize', action='store_true', help='æ‰§è¡Œä¸‰è½®ä¼˜åŒ–æœç´¢ï¼Œæ‰¾å‡ºæœ€ä½³é˜ˆå€¼')
    
    args = parser.parse_args()
    
    print("===== åŸºé‡‘å®šæŠ•æ”¶ç›Šåˆ†æ =====")
    print(f"åŸºé‡‘ID: {args.fund_id}")
    print(f"å®šæŠ•é‡‘é¢: {args.amount} å…ƒ")
    
    # ç¡®ä¿ç›®å½•å­˜åœ¨
    for directory in ["fund_data", "investment_results"]:
        if not os.path.exists(directory):
            os.makedirs(directory)
    
    # å¦‚æœæŒ‡å®šäº†é˜ˆå€¼ï¼Œåˆ™åªåˆ†æè¯¥é˜ˆå€¼
    if args.threshold is not None:
        threshold = args.threshold / 100  # è½¬æ¢ä¸ºå°æ•°
        print(f"æ”¶ç›Šé˜ˆå€¼: {args.threshold}%")
        
        fund_investment = FundInvestment(
            fund_id=args.fund_id,
            investment_amount=args.amount,
            profit_threshold=threshold
        )
        
        # åŠ è½½æ•°æ®
        fund_investment.fund_data = fund_investment.load_fund_data(refresh=args.refresh)
        
        # è¿è¡ŒæŠ•èµ„ç­–ç•¥
        fund_investment.run_investment_strategy()
    
    # å¦‚æœæŒ‡å®šäº†ä¼˜åŒ–é€‰é¡¹ï¼Œæ‰§è¡Œä¸‰è½®æœç´¢
    elif args.optimize:
        find_optimal_thresholds(
            fund_id=args.fund_id,
            investment_amount=args.amount,
            refresh_data=args.refresh
        )
    
    else:
        # æ‰§è¡Œæ ‡å‡†çš„å¤šé˜ˆå€¼åˆ†æ
        analyze_multiple_thresholds(
            fund_id=args.fund_id,
            investment_amount=args.amount,
            min_threshold=0.1,
            max_threshold=1.0,
            step=0.1,
            refresh_data=args.refresh,
            precision=1  # è¿›è¡Œä¸€è½®æ›´ç²¾ç¡®çš„æœç´¢
        )


if __name__ == "__main__":
    main()
